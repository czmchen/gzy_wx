<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yq.dao.DistributionDao" >
  
   <select id="search" resultType="com.yq.vo.DistributionVo">
	   select tx.* from (
		    (select t.*,g.storeImg custStoreImg,ROUND(
		6378.138 * 2 * ASIN(
			SQRT(
			POW( SIN(( ".$latitude." * PI()/ 180-t.latitude * PI()/ 180 )/ 2 ), 2 )+ COS( ".$latitude." * PI()/ 180 )* COS( t.latitude * PI()/ 180 )* POW( SIN(( ".$longitude." * PI()/ 180-t.longitude * PI()/ 180 )/ 2 ), 2 )))* 1000 
	) AS distance from ganzhu_common_db.tb_distribution t LEFT JOIN WxUserCust g on t.openid = g.openid
		    <include refid="searchWhereSQL"/>
			and t.signStatus=0 order by distance asc limit 99999999)
			 union all
			 (select t.*,g.storeImg custStoreImg,'' distance from ganzhu_common_db.tb_distribution  t LEFT JOIN WxUserCust g on t.openid = g.openid 
		    <include refid="searchWhereSQL"/>
			and t.signStatus=1 order by t.lastUpdateTime desc limit 99999999)
		 ) tx
  </select>
  
  <sql id="searchWhereSQL">
	  <where>
			t.recDate >= date_sub(curdate(),interval 7 day) 
			<if test="recDate!=null and recDate!=''">
				and t.recDate = #{recDate} 
			</if>
			<if test="driverOpenId!=null and driverOpenId!=''">
				and t.driverOpenId = #{driverOpenId} 
			</if>
			<if test="recStatus!=null and recStatus!=''">
				and t.recStatus = #{recStatus} 
			</if>
			<if test="goodsDetail!=null and goodsDetail!=''">
				and (t.goodsDetail like concat('%',#{goodsDetail},'%') 
				 	or t.reciever like concat('%',#{goodsDetail},'%') 
				 	or t.orderNum like concat('%',#{goodsDetail},'%')
				 	or t.address like concat('%',#{goodsDetail},'%')
				 	or t.mobileNum like concat('%',#{goodsDetail},'%')
				) 
			</if>
		</where>
  </sql>
  
  <update id="update" parameterType="com.yq.entity.Distribution">
	    update ganzhu_common_db.tb_distribution set
    	    <if test="storeImg!=null and storeImg!=''">
		     	storeImg=#{storeImg},
		    </if>
    	    <if test="recStatus!=null and recStatus!=''">
		     	recStatus=#{recStatus},
		    </if>
		    <if test="sortNum!=null and sortNum!=''">
		     	sortNum=#{sortNum},
		    </if>
		    <if test="sortDateTime!=null and sortDateTime!=''">
		     	sortDateTime=#{sortDateTime},
		    </if>
		    <if test="actionLogs!=null and actionLogs!=''">
		     	actionLogs= CONCAT(IFNULL(actionLogs,''),#{actionLogs},'\r\n'),
		    </if>
		    <if test="latitude!=null and latitude!=''">
		     	latitude=#{latitude},
		    </if>
		    <if test="longitude!=null and longitude!=''">
		     	longitude=#{longitude},
		    </if>
		    <if test="merchantsId!=null">
		     	merchantsId=#{merchantsId},
		    </if>
		    lastUpdateTime = now()
	    where id=#{id}
    </update>
    
     <update id="orderSign" parameterType="com.yq.entity.Distribution">
	    update ganzhu_common_db.tb_distribution set signStatus = 1,actionLogs= CONCAT(IFNULL(actionLogs,''),#{actionLogs},'\r\n') 
	    where orderNum = #{orderNum}
    </update>
  
</mapper>